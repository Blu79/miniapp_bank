<script>
  const tg = window.Telegram.WebApp;
  tg.ready();
  tg.expand();

  // L·∫•y user t·ª´ Telegram WebApp (n·∫øu m·ªü ƒë√∫ng t·ª´ trong Telegram)
  let user = tg.initDataUnsafe && tg.initDataUnsafe.user;

  // Fallback: ƒë·ªçc uid / uname truy·ªÅn t·ª´ bot qua query (?uid=...&uname=...)
  const params = new URLSearchParams(window.location.search);
  const fallbackUid = params.get("uid");
  const fallbackUname = params.get("uname");

  // üëâ ƒê·ªîI TH√ÄNH USERNAME BOT TH·∫¨T C·ª¶A B·∫†N (kh√¥ng c√≥ @)
  const BOT_USERNAME = "YourBotUsername";  // v√≠ d·ª•: MiniBankVND_Bot

  const subtitleEl = document.getElementById("subtitle");
  const userNameEl = document.getElementById("userName");
  const userIdEl = document.getElementById("userId");
  const diamondBalanceEl = document.getElementById("diamondBalance");
  const goldBalanceEl = document.getElementById("goldBalance");
  const inviteLinkEl = document.getElementById("inviteLink");
  const inviteDescEl = document.getElementById("inviteDesc");

  const navItems = document.querySelectorAll(".nav-item");
  const pages = document.querySelectorAll(".page");

  // Demo state
  let diamonds = 1000;
  let gold = 3000001;
  let lastMineTs = 0;
  const MINE_COOLDOWN = 5 * 60 * 1000; // 5 ph√∫t

  function updateBalancesUI() {
    diamondBalanceEl.textContent = diamonds.toLocaleString("vi-VN");
    goldBalanceEl.textContent = gold.toLocaleString("vi-VN");
  }

  function buildRefLink(id) {
    return `https://t.me/${BOT_USERNAME}?start=${id}`;
  }

  function updateUserUI() {
    if (user) {
      // Tr∆∞·ªùng h·ª£p chu·∫©n: m·ªü t·ª´ Telegram WebApp
      const fullName = [user.first_name, user.last_name].filter(Boolean).join(" ");
      const username = user.username ? "@" + user.username : "kh√¥ng c√≥ username";

      subtitleEl.textContent = `Xin ch√†o, ${fullName}!`;
      userNameEl.textContent = fullName || "Kh√¥ng t√™n";
      userIdEl.textContent = `Kh√°ch ID ${user.id} ‚Ä¢ ${username}`;

      const refLink = buildRefLink(user.id);
      inviteLinkEl.textContent = refLink;
      inviteDescEl.textContent = "Link m·ªùi c·ªßa b·∫°n:";
    } else if (fallbackUid) {
      // Fallback: WebApp kh√¥ng c√≥ user nh∆∞ng c√≥ uid t·ª´ query
      const fullName = "Kh√°ch " + fallbackUid;
      const username = fallbackUname ? "@" + fallbackUname : "kh√¥ng c√≥ username";

      subtitleEl.textContent = `Xin ch√†o, ${fullName}!`;
      userNameEl.textContent = fullName;
      userIdEl.textContent = `Kh√°ch ID ${fallbackUid} ‚Ä¢ ${username}`;

      const refLink = buildRefLink(fallbackUid);
      inviteLinkEl.textContent = refLink;
      inviteDescEl.textContent = "Link m·ªùi c·ªßa b·∫°n (fallback):";
    } else {
      // M·ªü tr·ª±c ti·∫øp tr√™n Chrome ‚Üí kh√¥ng bi·∫øt user
      subtitleEl.textContent = "Kh√¥ng l·∫•y ƒë∆∞·ª£c th√¥ng tin t√†i kho·∫£n t·ª´ Telegram.";
      userNameEl.textContent = "Kh√°ch";
      userIdEl.textContent = "ID ?";
      inviteLinkEl.textContent = "Vui l√≤ng m·ªü mini app t·ª´ bot ƒë·ªÉ c√≥ link m·ªùi.";
      inviteDescEl.textContent = "Kh√¥ng t√¨m th·∫•y th√¥ng tin user.";
    }
  }

  function showPage(targetId) {
    pages.forEach(p => {
      p.id === targetId ? p.classList.remove("hidden") : p.classList.add("hidden");
    });
  }

  navItems.forEach(item => {
    item.addEventListener("click", () => {
      const target = item.getAttribute("data-target");
      navItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");
      showPage(target);
    });
  });

  // Buttons
  const btnMine = document.getElementById("btnMine");
  const mineStatusEl = document.getElementById("mineStatus");
  const btnConvert = document.getElementById("btnConvert");
  const btnOpenBotFromHome = document.getElementById("btnOpenBotFromHome");
  const btnAdGold = document.getElementById("btnAdGold");
  const btnAdDiamond = document.getElementById("btnAdDiamond");
  const btnOpenMainChannel = document.getElementById("btnOpenMainChannel");
  const btnCopyRef = document.getElementById("btnCopyRef");
  const btnShareRef = document.getElementById("btnShareRef");
  const btnOpenBotWithdraw = document.getElementById("btnOpenBotWithdraw");

  function updateMineStatus() {
    if (!lastMineTs) {
      mineStatusEl.textContent = "C√≥ th·ªÉ nh·∫≠n ngay b√¢y gi·ªù";
      return;
    }
    const diff = Date.now() - lastMineTs;
    if (diff >= MINE_COOLDOWN) {
      mineStatusEl.textContent = "C√≥ th·ªÉ nh·∫≠n ngay b√¢y gi·ªù";
    } else {
      const remain = Math.ceil((MINE_COOLDOWN - diff) / 1000);
      const m = Math.floor(remain / 60);
      const s = remain % 60;
      mineStatusEl.textContent = `Vui l√≤ng ch·ªù ${m}m ${s < 10 ? "0"+s : s}s`;
    }
  }

  btnMine.addEventListener("click", () => {
    const diff = Date.now() - lastMineTs;
    if (diff < MINE_COOLDOWN && lastMineTs !== 0) {
      updateMineStatus();
      tg.showAlert("‚è± B·∫°n v·ª´a nh·∫≠n r·ªìi, h√£y ch·ªù th√™m 5 ph√∫t n·ªØa nh√©!");
      return;
    }
    const bonus = Math.floor(Math.random() * 3) + 1; // 1‚Äì3
    diamonds += bonus;
    lastMineTs = Date.now();
    updateBalancesUI();
    updateMineStatus();
    tg.showPopup({
      title: "‚õè Khai th√°c th√†nh c√¥ng!",
      message: `B·∫°n nh·∫≠n ƒë∆∞·ª£c ${bonus} üíé may m·∫Øn.`,
      buttons: [{id: "ok", type: "default", text: "OK"}]
    });
  });

  setInterval(updateMineStatus, 1000);

  btnConvert.addEventListener("click", () => {
    if (diamonds <= 0) {
      tg.showAlert("B·∫°n kh√¥ng c√≥ üíé ƒë·ªÉ quy ƒë·ªïi.");
      return;
    }
    const gain = diamonds * 1000;
    gold += gain;
    diamonds = 0;
    updateBalancesUI();
    tg.showPopup({
      title: "üí± Quy ƒë·ªïi th√†nh c√¥ng",
      message: `B·∫°n ƒë√£ ƒë·ªïi ${gain.toLocaleString("vi-VN")} ü™ô t·ª´ kim c∆∞∆°ng.`,
      buttons: [{id: "ok", type: "default", text: "OK"}]
    });
  });

  btnOpenBotFromHome.addEventListener("click", () => tg.close());
  btnOpenBotWithdraw.addEventListener("click", () => tg.close());

  btnAdGold.addEventListener("click", () => {
    gold += 20000;
    updateBalancesUI();
    tg.showAlert("Demo: c·ªông 20.000 ü™ô. Khi l√†m th·∫≠t h√£y g·∫Øn API / check xem qu·∫£ng c√°o.");
  });

  btnAdDiamond.addEventListener("click", () => {
    diamonds += 50;
    updateBalancesUI();
    tg.showAlert("Demo: c·ªông 50 üíé. Khi l√†m th·∫≠t h√£y g·∫Øn API / check xem qu·∫£ng c√°o.");
  });

  btnOpenMainChannel.addEventListener("click", () => {
    const channelUrl = "https://t.me/"; // TODO: s·ª≠a th√†nh k√™nh ch√≠nh c·ªßa b·∫°n
    tg.openTelegramLink(channelUrl);
  });

  btnCopyRef.addEventListener("click", async () => {
    const link = inviteLinkEl.textContent.trim();
    if (!link || link.startsWith("Vui l√≤ng")) {
      tg.showAlert("Kh√¥ng t√¨m th·∫•y link m·ªùi.");
      return;
    }
    try {
      await navigator.clipboard.writeText(link);
      tg.showPopup({
        title: "ƒê√£ sao ch√©p",
        message: "Link m·ªùi ƒë√£ ƒë∆∞·ª£c copy, d√°n v√† g·ª≠i cho b·∫°n b√® nh√©!",
        buttons: [{id: "ok", type: "default", text: "OK"}]
      });
    } catch (e) {
      tg.showAlert("Kh√¥ng copy ƒë∆∞·ª£c, h√£y copy tay:\n" + link);
    }
  });

  btnShareRef.addEventListener("click", () => {
    const link = inviteLinkEl.textContent.trim();
    if (!link || link.startsWith("Vui l√≤ng")) {
      tg.showAlert("Kh√¥ng t√¨m th·∫•y link m·ªùi.");
      return;
    }
    tg.openTelegramLink(link);
  });

  // Kh·ªüi t·∫°o
  updateBalancesUI();
  updateUserUI();
  showPage("page-home");
</script>
